<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒˆ</text></svg>">
  <title>Gold Risk Monitor</title>
  <style>
    :root {
      color-scheme: light dark;
      --green: #2d6a4f;
      --blue: #2563eb;
      --orange: #f97316;
      --red: #b91c1c;
      --gray: #334155;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --row-alt: #f8fafc;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 20px 64px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    h1 {
      margin: 0;
      font-size: 32px;
      letter-spacing: -0.02em;
    }
    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #0f172a;
      background: #e2e8f0;
      border: 1px solid #cbd5f5;
      min-width: 100px;
      justify-content: center;
    }
    .badge.green { background: #dcfce7; color: #14532d; border-color: #bbf7d0; }
    .badge.blue { background: #dbeafe; color: #1e3a8a; border-color: #bfdbfe; }
    .badge.orange { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
    .badge.red { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .meta {
      font-size: 14px;
      color: var(--muted);
    }
    .status-summary {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .status-explainer {
      font-size: 14px;
      color: var(--muted);
    }
    .header-note {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }
    .section-explainer {
      margin: 6px 0 0;
      font-size: 14px;
      color: var(--muted);
    }
    .section {
      margin-top: 28px;
    }
    .section-card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: none;
      border: 1px solid var(--border);
      margin-top: 16px;
    }
    .section-card #reasonLead {
      font-size: 15px;
      color: var(--text);
      margin-bottom: 12px;
    }
    .section-card #reasons {
      margin: 0;
      padding-left: 20px;
      font-size: 15px;
      color: var(--text);
    }
    .section-card #reasons li {
      margin-bottom: 8px;
    }
    .section-card #reasons li:last-child {
      margin-bottom: 0;
    }
    .card-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-top: 12px;
    }
    .metric-card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      box-shadow: none;
      border: 1px solid var(--border);
    }
    .metric-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .metric-card .value {
      font-size: 20px;
      font-weight: 700;
    }
    .metric-card .subtle {
      font-size: 13px;
      color: var(--muted);
    }
    .metric-card .why {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #e2e8f0;
      color: #334155;
      margin-left: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: none;
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 15px;
      vertical-align: top;
    }
    th {
      background: #f1f5f9;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.08em;
    }
    tbody tr:nth-child(odd) {
      background: var(--row-alt);
    }
    td.num, th.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .context {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .note {
      margin-top: 12px;
      padding: 12px 16px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: none;
      border: 1px solid var(--border);
      font-size: 14px;
      color: var(--text);
    }
    .note ul {
      margin: 0;
      padding-left: 20px;
    }
    .metric-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .metric-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      background: #94a3b8;
    }
    .metric-indicator.green { background: var(--green); }
    .metric-indicator.orange { background: var(--orange); }
    .metric-indicator.red { background: var(--red); }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }
    footer {
      margin-top: 32px;
      font-size: 13px;
      color: #64748b;
    }
    a { color: inherit; }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --card: #0f172a;
        --border: #1e293b;
        --muted: #94a3b8;
        --shadow: none;
        --row-alt: #0b1a30;
        --text: #e2e8f0;
      }
      body { color: var(--text); }
      th { background: #111c33; }
    }
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
      }
      main {
        overflow-x: hidden;
      }
      .status-row {
        align-items: stretch;
      }
      #status {
        width: auto;
        align-self: stretch;
        justify-content: center;
      }
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
      }
      .table-container table {
        min-width: 600px;
        width: 100%;
      }
      th, td {
        display: table-cell;
      }
      th, td {
        padding: 8px 10px;
        font-size: 13px;
      }
      .badge {
        min-width: 80px;
        padding: 10px 14px;
        font-size: 16px;
      }
      .section-card {
        padding: 14px 16px;
      }
      main {
        padding: 24px 16px 48px;
      }
      h1 {
        font-size: 28px;
      }
      .status-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Gold Risk Monitor</h1>
      <p class="header-note">This monitor is designed to describe market regimes and transitions, not to forecast specific price levels or timing.</p>
      <div class="status-row">
        <div id="status" class="badge">Loading...</div>
        <div id="statusSummary" class="status-summary">Loading status summary...</div>
      </div>
      <div class="meta" id="timestamps">Waiting for data...</div>
      <div class="meta" id="confidence">Data coverage: checking...</div>
      <div class="meta">Percentiles compare current values with historical distributions to provide context rather than absolute judgments. Coverage notes indicate whether comparisons are based on a full five-year window or a shorter available history, helping calibrate confidence in the percentile labels.</div>
      <div class="meta">Status describes market regime only; it does not imply actions.</div>
    </header>

    <section class="section">
      <h2>At a glance</h2>
      <p class="section-explainer">This section highlights the small set of indicators that most often explain the current regime. Together, they show how stretched price is relative to trend, how recent momentum looks, whether investor demand is supportive, and whether macro conditions are acting as a headwind or tailwind.</p>
      <div class="card-grid" id="glanceCards">
        <div class="metric-card">Loading key metrics...</div>
      </div>
    </section>

    <section class="section">
      <h2>Regime drivers</h2>
      <p class="section-explainer">Regime drivers list the specific signals responsible for the current status. These are the conditions that crossed defined thresholds and explain why the monitor classifies the market the way it does today. This is intended to make the classification transparent rather than opaque.</p>
      <div class="section-card">
        <div class="meta" id="reasonLead">Loading regime drivers...</div>
        <ul id="reasons">
          <li>Loading regime drivers...</li>
        </ul>
      </div>
    </section>

    <section class="section">
      <h2>What would change the color</h2>
      <p class="section-explainer">This section documents the definitions behind regime transitions. It shows the conditions that would cause the status to move from one regime to another, making the framework explicit and repeatable rather than subjective.</p>
      <div id="escalation">
        <p>Loading escalation conditions...</p>
      </div>
    </section>

    <section class="section">
      <h2>Horizon Snapshot</h2>
      <p class="section-explainer">The horizon snapshot shows returns and drawdowns across multiple time frames to provide context on how broad or narrow recent strength has been. Comparing short-term and longer-term horizons helps distinguish isolated momentum from more persistent trends, as well as whether drawdowns are shallow or deepening.</p>
      <p class="section-explainer" id="horizonSummary">Horizon snapshot loading...</p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Horizon</th>
              <th class="num">Return</th>
              <th class="num">Return Percentile</th>
              <th class="num">Max Drawdown</th>
              <th class="num">Drawdown Percentile</th>
              <th>Context</th>
            </tr>
          </thead>
          <tbody id="horizonRows">
            <tr><td colspan="6">Loading horizon metrics...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="note" id="percentileNotes"></div>
    </section>

    <section class="section">
      <h2>Extension</h2>
      <p class="section-explainer">Extension measures how far price has moved relative to its longer-term trend. It provides context on whether recent gains are close to historical norms or unusually stretched compared with prior periods.</p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th class="num">Value</th>
              <th class="num">Percentile</th>
            </tr>
          </thead>
          <tbody id="extensionRows">
            <tr><td colspan="3">Loading extension data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2>Flow (short-term)</h2>
      <p class="section-explainer">Flow metrics track changes in GLD holdings as a proxy for investor demand. They help distinguish between price moves that are broadly supported by inflows and those that occur alongside weakening participation.</p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th class="num">Value</th>
              <th class="num">Percentile</th>
            </tr>
          </thead>
          <tbody id="flowRows">
            <tr><td colspan="3">Loading flow data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2>Macro (short-term)</h2>
      <p class="section-explainer">Macro metrics focus on changes in real yields, which historically influence gold pricing. Rapid shifts in real yields can coincide with repricing across gold and related assets, making them useful for contextualizing price action.</p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th class="num">Value</th>
              <th class="num">Percentile</th>
            </tr>
          </thead>
          <tbody id="macroRows">
            <tr><td colspan="3">Loading macro data...</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2>Status colors</h2>
      <p class="section-explainer">The status label summarizes multiple indicators into a single market regime classification.</p>
      <div class="section-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge green">GREEN</div>
          <div>Typical conditions.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge blue">BLUE</div>
          <div>Extended rally; no confirmed deterioration.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge orange">ORANGE</div>
          <div>Extended + early deterioration signals.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="badge red">RED</div>
          <div>Breakdown-style stress signals present.</div>
        </div>
      </div>
    </section>

    <footer>
      <p>
        Data is refreshed daily by GitHub Actions. View the repository on
        <a id="repoLink" href="https://github.com/">GitHub</a>.
        <span id="issueLink"></span>
      </p>
    </footer>
  </main>

  <script>
    const formatPercent = (value) => `${(value * 100).toFixed(2)}%`;
    const formatBp = (value) => `${value.toFixed(0)} bp`;
    const formatTonnes = (value) => `${value.toFixed(1)} t`;
    const formatTimestamp = (isoString) => {
      const date = new Date(isoString);
      const month = date.toLocaleString('en-US', { month: 'short' });
      const day = date.getDate();
      const year = date.getFullYear();
      const time = date.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      return `${month} ${day}, ${year} ${time}`;
    };

    const statusEl = document.getElementById('status');
    const statusSummaryEl = document.getElementById('statusSummary');
    const timestampsEl = document.getElementById('timestamps');
    const confidenceEl = document.getElementById('confidence');
    const reasonLeadEl = document.getElementById('reasonLead');
    const reasonsEl = document.getElementById('reasons');
    const glanceCardsEl = document.getElementById('glanceCards');
    const escalationEl = document.getElementById('escalation');
    const horizonSummaryEl = document.getElementById('horizonSummary');
    const horizonRows = document.getElementById('horizonRows');
    const percentileNotesEl = document.getElementById('percentileNotes');
    const extensionRows = document.getElementById('extensionRows');
    const flowRows = document.getElementById('flowRows');
    const macroRows = document.getElementById('macroRows');
    const repoLink = document.getElementById('repoLink');
    const issueLink = document.getElementById('issueLink');

    const contextTag = (text) => (text ? `<span class="context">${text}</span>` : '');
    const badgeDescriptions = {
      GREEN: 'Typical conditions.',
      BLUE: 'Extended rally; no confirmed deterioration.',
      ORANGE: 'Extended + early deterioration signals.',
      RED: 'Breakdown-style stress signals present.'
    };
    const REASON_LABELS = {
      extension_ret_pctile_90: '3M return is extreme (â‰¥90th percentile)',
      extension_200dma_pctile_90: '% above 200DMA is extreme (â‰¥90th percentile)',
      extension_drawdown_pctile_70: '3M drawdown has been unusually shallow (â‰¥70th percentile)',
      deterioration_flow_divergence: 'Holdings falling while price rising (flow divergence)',
      deterioration_macro_turn: 'Real yields rising quickly (macro headwind)',
      deterioration_price_crack: 'Short-term weakness / drawdown worsening (price crack)'
    };
    const percentileContext = (value) => {
      if (value == null) return 'N/A';
      if (value <= 20) return 'low';
      if (value <= 79) return 'typical';
      if (value <= 94) return 'high';
      return 'extreme';
    };
    const percentileWord = (value) => {
      const context = percentileContext(value);
      if (context === 'N/A') return 'N/A';
      return `${context[0].toUpperCase()}${context.slice(1)}`;
    };
    const dedupeNote = (note) => {
      if (!note) return note;
      return note.replace(/(\bused available history\b)(\s+\1)+/gi, '$1');
    };
    const formatOrdinal = (value) => {
      const rounded = Math.round(value);
      const mod10 = rounded % 10;
      const mod100 = rounded % 100;
      if (mod10 === 1 && mod100 !== 11) return `${rounded}st`;
      if (mod10 === 2 && mod100 !== 12) return `${rounded}nd`;
      if (mod10 === 3 && mod100 !== 13) return `${rounded}rd`;
      return `${rounded}th`;
    };
    const percentileLabel = (basis, count) => {
      if (!basis || basis === 'none') return 'N/A';
      const label = basis === 'available' ? 'available history' : '5y window';
      const suffix = typeof count === 'number' ? ` (n=${count})` : '';
      return `${label}${suffix}`;
    };
    const percentileText = (value, explain, basis, count) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      const basisLabel = percentileLabel(basis, count);
      const cleaned = dedupeNote(explain);
      return `${percentileWord(value)} (${formatOrdinal(value)})${contextTag(cleaned ? `Note: ${cleaned}` : basisLabel)}`;
    };
    const valueOrNA = (value, formatter, explain) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      return `${formatter(value)}${contextTag(explain)}`;
    };
    const basisTag = (basis) => (basis === 'available' ? '<span class="pill">available</span>' : '');
    const buildCard = (title, value, percentile, label, why) => `
      <div class="metric-card">
        <h3>${title}</h3>
        <div class="value">${value}</div>
        <div class="subtle">${label}${percentile != null ? ` â€¢ ${percentileWord(percentile)} (${formatOrdinal(percentile)})` : ''}</div>
        <div class="why">${why}</div>
      </div>
    `;
    const coverageSummary = (basisValues, missingCount) => {
      if (missingCount > 0) {
        return 'Data coverage: limited (some percentiles are unavailable).';
      }
      if (basisValues.includes('available')) {
        return 'Data coverage: mixed (some percentiles use available history).';
      }
      return 'Data coverage: strong (most percentiles use a 5y window).';
    };

    fetch('data.json', { cache: 'no-store' })
      .then((response) => response.json())
      .then((data) => {
        const regime = data.regime || {};
        const state = regime.state || data.flag || 'UNKNOWN';
        statusEl.textContent = state;
        statusEl.classList.remove('green', 'blue', 'orange', 'red');
        statusEl.classList.add(state.toLowerCase());
        statusSummaryEl.textContent = badgeDescriptions[state] || 'Status summary unavailable.';

        if (data.updated_at) {
          const etFormatted = formatTimestamp(data.updated_at);
          timestampsEl.textContent = `Updated ${etFormatted}`;
        }

        const reasons = regime.reasons || data.flag_triggers || [];
        reasonLeadEl.innerHTML = `<strong>${state}</strong> because:`;
        reasonsEl.innerHTML = reasons.length
          ? reasons.map((item) => {
            const label = REASON_LABELS[item] || item;
            return `<li title="${item}">${label}</li>`;
          }).join('')
          : '<li>No active triggers.</li>';

        const metrics = data.metrics || {};
        const horizons = metrics.horizons || {};
        const horizonOrder = ['3M', '6M', '1Y', '3Y', '5Y'];
        const basisValues = [];
        let missingCount = 0;
        horizonRows.innerHTML = horizonOrder.map((label) => {
          const horizon = horizons[label] || {};
          const available = horizon.available !== false && horizon.ret != null;
          const returnCell = available
            ? formatPercent(horizon.ret)
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const returnPctCell = available
            ? percentileText(
              horizon.ret_pctile_5y,
              horizon.ret_pctile_5y_explain,
              horizon.ret_pctile_basis,
              horizon.ret_pctile_n
            )
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const drawdownCell = available
            ? formatPercent(horizon.max_drawdown)
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          const drawdownPctCell = available
            ? percentileText(
              horizon.max_drawdown_pctile_5y,
              horizon.max_drawdown_pctile_5y_explain,
              horizon.max_drawdown_pctile_basis,
              horizon.max_drawdown_pctile_n
            )
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          if (horizon.ret_pctile_basis) basisValues.push(horizon.ret_pctile_basis);
          if (horizon.max_drawdown_pctile_basis) basisValues.push(horizon.max_drawdown_pctile_basis);
          if (!available) missingCount += 1;
          const labelNote = basisTag(horizon.ret_pctile_basis || horizon.max_drawdown_pctile_basis);
          const contextValue = percentileContext(horizon.ret_pctile_5y ?? horizon.max_drawdown_pctile_5y);
          return `
            <tr>
              <td>${label}${labelNote}</td>
              <td class="num">${returnCell}</td>
              <td class="num">${returnPctCell}</td>
              <td class="num">${drawdownCell}</td>
              <td class="num">${drawdownPctCell}</td>
              <td>${contextValue}</td>
            </tr>
          `;
        }).join('');

        const percentileNotes = data.notes?.percentile_notes || {};
        const notesEntries = Object.entries(percentileNotes);
        const notesText = notesEntries.length
          ? notesEntries.map(([key, value]) => `${key}: ${dedupeNote(value)}`).join(' | ')
          : 'none';
        const needsDetails = notesText.length > 140 || notesEntries.length > 2;
        percentileNotesEl.innerHTML = needsDetails
          ? `<details><summary>Percentile notes</summary>${notesText}</details>`
          : `<strong>Percentile notes:</strong> ${notesText}`;

        extensionRows.innerHTML = `
          <tr>
            <td>GLD % above 200DMA</td>
            <td class="num">${valueOrNA(metrics.pct_above_200dma, formatPercent)}</td>
            <td class="num">${percentileText(
              metrics.pct_above_200dma_pctile_5y,
              metrics.pct_above_200dma_pctile_5y_explain,
              metrics.pct_above_200dma_pctile_basis,
              metrics.pct_above_200dma_pctile_n
            )}</td>
          </tr>
        `;
        if (metrics.pct_above_200dma_pctile_basis) basisValues.push(metrics.pct_above_200dma_pctile_basis);

        const flows = metrics.flows || {};
        flowRows.innerHTML = `
          <tr>
            <td>Holdings today (tonnes)</td>
            <td class="num">${valueOrNA(flows.holdings_today_tonnes, formatTonnes)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Holdings change (5D)</td>
            <td class="num">${valueOrNA(flows.holdings_change_5d_pct, formatPercent)}</td>
            <td class="num">${percentileText(
              flows.holdings_change_5d_pct_pctile_5y,
              flows.holdings_change_5d_pct_pctile_5y_explain,
              flows.holdings_change_5d_pctile_basis,
              flows.holdings_change_5d_pctile_n
            )}</td>
          </tr>
          <tr>
            <td>Holdings change (21D)</td>
            <td class="num">${valueOrNA(flows.holdings_change_21d_pct, formatPercent)}</td>
            <td class="num">${percentileText(
              flows.holdings_change_21d_pct_pctile_5y,
              flows.holdings_change_21d_pct_pctile_5y_explain,
              flows.holdings_change_21d_pctile_basis,
              flows.holdings_change_21d_pctile_n
            )}</td>
          </tr>
        `;
        if (flows.holdings_change_5d_pctile_basis) basisValues.push(flows.holdings_change_5d_pctile_basis);
        if (flows.holdings_change_21d_pctile_basis) basisValues.push(flows.holdings_change_21d_pctile_basis);

        const macro = metrics.macro || {};
        macroRows.innerHTML = `
          <tr>
            <td>Real yield today (DFII10)</td>
            <td class="num">${valueOrNA(macro.real_yield_today, (value) => `${value.toFixed(2)}%`)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Real yield change (1M)</td>
            <td class="num">${valueOrNA(macro.real_yield_change_1m_bp, formatBp)}</td>
            <td class="num">${percentileText(
              macro.real_yield_change_1m_bp_pctile_5y,
              macro.real_yield_change_1m_bp_pctile_5y_explain,
              macro.real_yield_change_1m_bp_pctile_basis,
              macro.real_yield_change_1m_bp_pctile_n
            )}</td>
          </tr>
          <tr>
            <td>Real yield change (3M)</td>
            <td class="num">${valueOrNA(macro.real_yield_change_3m_bp, formatBp)}</td>
            <td class="num">${percentileText(
              macro.real_yield_change_3m_bp_pctile_5y,
              macro.real_yield_change_3m_bp_pctile_5y_explain,
              macro.real_yield_change_3m_bp_pctile_basis,
              macro.real_yield_change_3m_bp_pctile_n
            )}</td>
          </tr>
        `;
        if (macro.real_yield_change_1m_bp_pctile_basis) basisValues.push(macro.real_yield_change_1m_bp_pctile_basis);
        if (macro.real_yield_change_3m_bp_pctile_basis) basisValues.push(macro.real_yield_change_3m_bp_pctile_basis);

        const glanceCards = [
          buildCard(
            'Extension',
            valueOrNA(metrics.pct_above_200dma, formatPercent),
            metrics.pct_above_200dma_pctile_5y,
            'vs 200DMA',
            'How stretched price is vs trend'
          ),
          buildCard(
            '3M Return',
            valueOrNA(horizons['3M']?.ret, formatPercent),
            horizons['3M']?.ret_pctile_5y,
            'total return',
            'Recent momentum'
          ),
          buildCard(
            'Flows (21D)',
            valueOrNA(flows.holdings_change_21d_pct, formatPercent),
            flows.holdings_change_21d_pct_pctile_5y,
            '21D change',
            'ETF demand proxy'
          ),
          buildCard(
            'Real yields (1M)',
            valueOrNA(macro.real_yield_change_1m_bp, formatBp),
            macro.real_yield_change_1m_bp_pctile_5y,
            '1M change',
            'Macro pressure proxy'
          )
        ];
        glanceCardsEl.innerHTML = glanceCards.join('');

        const flowThreshold = -0.015;
        const macroThreshold = 25;
        const priceCrackThresholdReturn = 0;
        const priceCrackThresholdDrawdown = -0.08;
        const flowNow = flows.holdings_change_21d_pct;
        const macroNow = macro.real_yield_change_1m_bp;
        const priceNow = horizons['3M']?.ret;
        const drawdownNow = horizons['3M']?.max_drawdown;
        escalationEl.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Trigger</th>
                  <th class="num">Threshold</th>
                  <th class="num">Current</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Flow divergence (ORANGE)</td>
                  <td class="num">Holdings 21D â‰¤ ${formatPercent(flowThreshold)}</td>
                  <td class="num">${flowNow == null ? 'N/A' : formatPercent(flowNow)}</td>
                </tr>
                <tr>
                  <td>Macro turn (ORANGE)</td>
                  <td class="num">Real yield 1M â‰¥ ${formatBp(macroThreshold)}</td>
                  <td class="num">${macroNow == null ? 'N/A' : formatBp(macroNow)}</td>
                </tr>
                <tr>
                  <td>Price crack (ORANGE)</td>
                  <td class="num">3M return â‰¤ ${formatPercent(priceCrackThresholdReturn)} or drawdown â‰¤ ${formatPercent(priceCrackThresholdDrawdown)}</td>
                  <td class="num">${priceNow == null ? 'N/A' : formatPercent(priceNow)} / ${drawdownNow == null ? 'N/A' : formatPercent(drawdownNow)}</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;

        const shortTermContext = percentileContext(horizons['3M']?.ret_pctile_5y);
        const longTermContext = percentileContext(horizons['1Y']?.ret_pctile_5y);
        horizonSummaryEl.textContent = `Horizon snapshot: short-term ${shortTermContext}; long-term ${longTermContext}.`;

        const basisSummary = coverageSummary(basisValues, missingCount);
        confidenceEl.textContent = basisSummary;

        const repo = data.repository || 'https://github.com/';
        repoLink.href = repo;

        if (data.latest_issue_url) {
          issueLink.innerHTML = ` Latest issue: <a href="${data.latest_issue_url}">${data.latest_issue_url}</a>`;
        }
      })
      .catch((error) => {
        statusEl.textContent = 'DATA ERROR';
        statusEl.classList.add('red');
        horizonRows.innerHTML = `<tr><td colspan="6">Failed to load data.json: ${error}</td></tr>`;
      });
  </script>
</body>
</html>
