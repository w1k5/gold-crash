<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒˆ</text></svg>">
  <title>Gold Risk Monitor</title>
  <style>
    :root {
      color-scheme: light dark;
      --green: #2d6a4f;
      --blue: #2563eb;
      --orange: #f97316;
      --red: #b91c1c;
      --gray: #334155;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --row-alt: #f8fafc;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 20px 64px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    h1 {
      margin: 0;
      font-size: 32px;
      letter-spacing: -0.02em;
    }
    .hero {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: var(--card);
      border-radius: 20px;
      padding: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .hero-notes {
      display: grid;
      gap: 10px;
    }
    .hero-note {
      background: var(--row-alt);
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid var(--border);
    }
    .hero-note-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    .status-panel {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(249, 115, 22, 0.08));
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .status-panel-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .status-panel-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      font-weight: 600;
    }
    .status-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #0f172a;
      background: #e2e8f0;
      border: 1px solid #cbd5f5;
      min-width: 100px;
      justify-content: center;
    }
    .badge.green { background: #dcfce7; color: #14532d; border-color: #bbf7d0; }
    .badge.blue { background: #dbeafe; color: #1e3a8a; border-color: #bfdbfe; }
    .badge.orange { background: #ffedd5; color: #9a3412; border-color: #fed7aa; }
    .badge.red { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .meta {
      font-size: 14px;
      color: var(--muted);
    }
    .status-summary {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }
    .status-explainer {
      font-size: 14px;
      color: var(--muted);
    }
    .header-note {
      font-size: 14px;
      color: var(--muted);
      margin: 0;
    }
    .meta-note {
      font-size: 13px;
      color: var(--muted);
      margin: 0;
      line-height: 1.5;
    }
    .section-explainer {
      margin: 6px 0 0;
      font-size: 14px;
      color: var(--muted);
    }
    .section {
      margin-top: 28px;
    }
    .status-layer {
      background: rgba(255, 255, 255, 0.45);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-top: 24px;
    }
    .mechanics-layer {
      background: rgba(15, 23, 42, 0.03);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-top: 24px;
    }
    .context-layer {
      margin-top: 28px;
      padding-top: 8px;
    }
    .section-cut {
      border: none;
      border-top: 1px solid var(--border);
      margin: 22px 0 0;
    }
    .layer-controls {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .toggle-btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
    }
    .expandable-card {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--card);
      overflow: hidden;
    }
    .expandable-card > summary {
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-align: left;
      font-weight: 700;
      padding: 10px 16px;
      background: var(--card);
    }
    .expandable-card[open] > summary {
      border-bottom: 1px solid var(--border);
    }
    .expandable-card > summary::-webkit-details-marker {
      display: none;
    }
    .expandable-card > summary::after {
      content: 'â–¸';
      color: var(--muted);
      font-size: 14px;
      line-height: 1;
      margin-left: 10px;
      transition: transform 0.14s ease;
      transform-origin: center;
    }
    .expandable-card[open] > summary::after {
      transform: rotate(90deg);
    }
    .expandable-body {
      padding: 12px 16px 16px;
    }
    .expandable-body .section-explainer {
      margin-top: 0;
    }
    .expandable-body .table-container table {
      margin-top: 10px;
    }
    .section-card {
      background: var(--card);
      border-radius: 14px;
      padding: 18px 20px;
      box-shadow: none;
      border: 1px solid var(--border);
      margin-top: 16px;
    }
    .section-card #reasonLead {
      font-size: 15px;
      color: var(--text);
      margin-bottom: 12px;
    }
    .section-card #reasons {
      margin: 0;
      padding-left: 20px;
      font-size: 15px;
      color: var(--text);
    }
    .section-card #reasons li {
      margin-bottom: 8px;
    }
    .section-card #reasons li:last-child {
      margin-bottom: 0;
    }
    .reason-item {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .reason-help {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--row-alt);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
      line-height: 1;
      cursor: help;
      flex: 0 0 auto;
    }
    .reason-help-tooltip {
      position: absolute;
      left: 50%;
      top: calc(100% + 8px);
      transform: translateX(-50%);
      min-width: 220px;
      max-width: min(420px, calc(100vw - 48px));
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 12px;
      line-height: 1.4;
      box-shadow: var(--shadow);
      text-transform: none;
      letter-spacing: normal;
      white-space: normal;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      z-index: 5;
      transition: opacity 0.14s ease;
    }
    .reason-help:hover .reason-help-tooltip,
    .reason-help:focus-visible .reason-help-tooltip,
    .reason-help:active .reason-help-tooltip {
      opacity: 1;
      visibility: visible;
    }
    .card-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      margin-top: 12px;
    }
    .metric-card {
      background: var(--card);
      border-radius: 14px;
      padding: 16px;
      box-shadow: none;
      border: 1px solid var(--border);
    }
    .metric-card h3 {
      margin: 0 0 6px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }
    .metric-card .value {
      font-size: 20px;
      font-weight: 700;
    }
    .metric-card .subtle {
      font-size: 13px;
      color: var(--muted);
    }
    .metric-card .why {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .distance-cell {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      min-width: 120px;
    }
    .mini-thermo {
      position: relative;
      width: 110px;
      height: 7px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.25);
      overflow: visible;
    }
    .mini-thermo-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      border-radius: inherit;
      background: var(--blue);
      transition: width 0.2s ease;
    }
    .mini-thermo-marker {
      position: absolute;
      top: 50%;
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--card);
      border: 2px solid var(--blue);
      transform: translate(-50%, -50%);
      box-sizing: border-box;
      transition: left 0.2s ease;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      box-shadow: none;
    }
    th, td {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 15px;
      vertical-align: top;
    }
    th {
      background: #f1f5f9;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.08em;
    }
    tbody tr:nth-child(odd) {
      background: var(--row-alt);
    }
    td.num, th.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-family: ui-monospace, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .context {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
    .note {
      margin-top: 12px;
      padding: 12px 16px;
      background: var(--card);
      border-radius: 12px;
      box-shadow: none;
      border: 1px solid var(--border);
      font-size: 14px;
      color: var(--text);
    }
    .note ul {
      margin: 0;
      padding-left: 20px;
    }
    .metric-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .metric-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      background: #94a3b8;
    }
    .metric-indicator.green { background: var(--green); }
    .metric-indicator.orange { background: var(--orange); }
    .metric-indicator.red { background: var(--red); }
    details summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }
    footer {
      margin-top: 32px;
      font-size: 13px;
      color: #64748b;
    }
    a { color: inherit; }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --card: #0f172a;
        --border: #1e293b;
        --muted: #94a3b8;
        --shadow: none;
        --row-alt: #0b1a30;
        --text: #e2e8f0;
      }
      body { color: var(--text); }
      th { background: #111c33; }
    }
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
      }
      main {
        overflow-x: hidden;
      }
      .status-row {
        align-items: stretch;
      }
      #status {
        width: auto;
        align-self: stretch;
        justify-content: center;
      }
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
      }
      .table-container table {
        min-width: 600px;
        width: 100%;
      }
      th, td {
        display: table-cell;
      }
      th, td {
        padding: 8px 10px;
        font-size: 13px;
      }
      .badge {
        min-width: 80px;
        padding: 10px 14px;
        font-size: 16px;
      }
      .section-card {
        padding: 14px 16px;
      }
      main {
        padding: 24px 16px 48px;
      }
      h1 {
        font-size: 28px;
      }
      .status-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .hero {
        padding: 18px;
      }
      .card-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="hero">
        <h1>Gold Risk Monitor</h1>
        <p class="header-note">This monitor is designed to describe market regimes and transitions, not to forecast specific price levels or timing.</p>
        <p class="meta-note"><a href="https://w1k5.github.io/gold-crash/dislocation/">Dislocation detector â†’</a></p>
        <div class="status-panel">
          <div class="status-panel-header">
            <span class="status-panel-title">Current regime</span>
            <div class="meta" id="timestamps">Waiting for data...</div>
          </div>
          <div class="status-row">
            <div id="status" class="badge">Loading...</div>
            <div id="statusSummary" class="status-summary">Loading status summary...</div>
          </div>
          <div class="status-explainer" id="macroFollowThrough">Loading macro follow-through...</div>
        </div>
        <div class="hero-notes">
          <div class="hero-note">
            <span class="hero-note-title">Percentile context</span>
            <span class="meta-note">Percentiles compare current values with historical distributions to provide context rather than absolute judgments.</span>
          </div>
          <div class="hero-note">
            <span class="hero-note-title">Interpretation</span>
            <span class="meta-note">Status describes market regime only; it does not imply actions.</span>
          </div>
        </div>
      </div>
    </header>

    <div class="status-layer">
      <section class="section" style="margin-top: 0;">
        <h2 id="glanceHeading">A. What regime are we in?</h2>
        <p class="section-explainer">Start here. This summary is the primary interpretation of today's regime. Details and threshold mechanics are below.</p>
        <div class="card-grid" id="glanceCards">
          <div class="metric-card">Loading key metrics...</div>
        </div>
      </section>

      <section class="section">
        <h2>B. Why are we here today?</h2>
        <p class="section-explainer">Regime drivers are shown as supporting mechanics rather than headline status.</p>
        <div class="section-card">
          <details>
            <summary>Regime drivers (mechanics)</summary>
            <div class="meta" id="reasonLead">Loading regime drivers...</div>
            <ul id="reasons">
              <li>Loading regime drivers...</li>
            </ul>
          </details>
        </div>
      </section>
    </div>

    <div class="mechanics-layer">
      <section class="section" style="margin-top: 0;">
        <h2>C. What changes the regime next?</h2>
        <p class="section-explainer"><strong>Regime ladder:</strong> GREEN â†’ BLUE â†’ ORANGE â†’ RED. Each table shows what keeps the current level, what moves up, and what moves down.</p>
        <div class="layer-controls" aria-label="Mechanics expand controls">
          <button class="toggle-btn" type="button" data-toggle-scope="mechanics" data-toggle-action="expand">Expand mechanics</button>
          <button class="toggle-btn" type="button" data-toggle-scope="mechanics" data-toggle-action="collapse">Collapse mechanics</button>
        </div>
        <div id="escalation">
          <p>Loading escalation conditions...</p>
        </div>
      </section>

      <section class="section">
        <h2>Mechanics detail: factor tables</h2>
        <p class="section-explainer">These tables are diagnostic only. They do not override the regime by themselves.</p>
      </section>

      <section class="section">
        <details class="expandable-card" data-expand-group="mechanics">
          <summary>Extension</summary>
          <div class="expandable-body">
            <p class="section-explainer">Extension measures how far price has moved relative to its longer-term trend.</p>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="num">Value</th>
                    <th class="num">Percentile</th>
                  </tr>
                </thead>
                <tbody id="extensionRows">
                  <tr><td colspan="3">Loading extension data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>
      </section>

      <section class="section">
        <details class="expandable-card" data-expand-group="mechanics">
          <summary>Flow (short-term)</summary>
          <div class="expandable-body">
            <p class="section-explainer">Flow metrics track changes in GLD holdings as a proxy for investor demand.</p>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="num">Value</th>
                    <th class="num">Percentile</th>
                  </tr>
                </thead>
                <tbody id="flowRows">
                  <tr><td colspan="3">Loading flow data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>
      </section>

      <section class="section">
        <details class="expandable-card" data-expand-group="mechanics">
          <summary>Macro (short-term)</summary>
          <div class="expandable-body">
            <p class="section-explainer">Macro metrics focus on changes in real yields to contextualize price action.</p>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Metric</th>
                    <th class="num">Value</th>
                    <th class="num">Percentile</th>
                  </tr>
                </thead>
                <tbody id="macroRows">
                  <tr><td colspan="3">Loading macro data...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </details>
      </section>
    </div>

    <div class="context-layer">
      <hr class="section-cut">
      <section class="section">
      <details class="expandable-card" data-expand-group="context">
      <summary>D. Context only: horizon snapshot</summary>
      <div class="expandable-body">
      <p class="section-explainer">This does not affect the regime; it provides historical perspective.</p>
      <p class="section-explainer" id="horizonSummary">Horizon snapshot loading...</p>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Horizon</th>
              <th class="num">Return</th>
              <th class="num">Return Percentile</th>
              <th class="num">Max Drawdown</th>
              <th class="num">Drawdown Percentile</th>
              <th>Context</th>
            </tr>
          </thead>
          <tbody id="horizonRows">
            <tr><td colspan="6">Loading horizon metrics...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="note" id="percentileNotes"></div>
      </div>
      </details>
    </section>
    </div>

    <section class="section">
      <h2>Status colors</h2>
      <p class="section-explainer">The status label summarizes multiple indicators into a single market regime classification.</p>
      <div class="section-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge green">GREEN</div>
          <div>Typical conditions.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge blue">BLUE</div>
          <div>Extended rally; no confirmed deterioration.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <div class="badge orange">ORANGE</div>
          <div>Extended + early deterioration signals.</div>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="badge red">RED</div>
          <div>Breakdown-style stress signals present.</div>
        </div>
      </div>
    </section>

    <footer>
      <p>
        Data is refreshed daily by GitHub Actions. View the repository on
        <a id="repoLink" href="https://github.com/">GitHub</a>.
        <span id="issueLink"></span>
      </p>
    </footer>
  </main>

  <script>
    const formatPercent = (value) => `${(value * 100).toFixed(2)}%`;
    const formatNumber = (value, digits = 2) => `${value.toFixed(digits)}`;
    const formatBp = (value) => `${value.toFixed(0)} bp`;
    const formatTonnes = (value) => `${value.toFixed(1)} t`;
    const formatCorr = (value) => `${value.toFixed(2)}`;
    const formatTimestamp = (isoString) => {
      const date = new Date(isoString);
      const month = date.toLocaleString('en-US', { month: 'short' });
      const day = date.getDate();
      const year = date.getFullYear();
      const time = date.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      return `${month} ${day}, ${year} ${time}`;
    };

    const statusEl = document.getElementById('status');
    const statusSummaryEl = document.getElementById('statusSummary');
    const macroFollowThroughEl = document.getElementById('macroFollowThrough');
    const timestampsEl = document.getElementById('timestamps');
    const reasonLeadEl = document.getElementById('reasonLead');
    const reasonsEl = document.getElementById('reasons');
    const glanceCardsEl = document.getElementById('glanceCards');
    const escalationEl = document.getElementById('escalation');
    const horizonSummaryEl = document.getElementById('horizonSummary');
    const horizonRows = document.getElementById('horizonRows');
    const percentileNotesEl = document.getElementById('percentileNotes');
    const extensionRows = document.getElementById('extensionRows');
    const flowRows = document.getElementById('flowRows');
    const macroRows = document.getElementById('macroRows');
    const repoLink = document.getElementById('repoLink');
    const issueLink = document.getElementById('issueLink');
    const setExpandGroup = (group, expand) => {
      document.querySelectorAll(`[data-expand-group="${group}"]`).forEach((el) => {
        el.open = expand;
      });
    };
    document.querySelectorAll('[data-toggle-scope]').forEach((button) => {
      button.addEventListener('click', () => {
        const group = button.dataset.toggleScope;
        const action = button.dataset.toggleAction;
        setExpandGroup(group, action === 'expand');
      });
    });

    const contextTag = (text) => (text ? `<span class="context">${text}</span>` : '');
    const badgeDescriptions = {
      GREEN: 'Typical conditions.',
      BLUE: 'Extended rally; no confirmed deterioration.',
      ORANGE: 'Extended + early deterioration signals.',
      RED: 'Breakdown-style stress signals present.'
    };
    const CUT_LABELS = {
      CREDIBILITY_CUT: 'Credibility cut',
      STIMULUS_CUT: 'Stimulus cut',
      MIXED_CUT: 'Mixed cut',
      NO_CUTS_PRICED: 'No cuts priced',
      UNKNOWN: 'Unknown'
    };
    const cutWhyText = (label) => {
      switch (label) {
        case 'CREDIBILITY_CUT':
          return 'Cuts priced, but inflation expectations are falling faster than nominal yields â†’ real yields tend to rise.';
        case 'STIMULUS_CUT':
          return 'Cuts priced with reflation impulse â†’ breakevens rising and/or real yields falling.';
        case 'MIXED_CUT':
          return 'Cuts priced, but nominal and breakeven moves disagree (or are too small).';
        case 'NO_CUTS_PRICED':
          return 'Front-end rates are not falling enough to indicate meaningful cuts priced.';
        default:
          return 'Not enough data to classify.';
      }
    };
    const REASON_LABELS = {
      extension_ret_pctile_90: '3M return is extreme (â‰¥90th percentile)',
      extension_200dma_pctile_90: '% above 200DMA is extreme (â‰¥90th percentile)',
      extension_drawdown_pctile_70: '3M drawdown has been unusually shallow (â‰¥70th percentile)',
      deterioration_flow_divergence: 'Holdings falling while price rising (flow divergence)',
      deterioration_macro_turn: 'Real yields rising quickly (macro headwind)',
      deterioration_policy_conflict: 'Cuts priced + real yields rising (credibility headwind)',
      deterioration_price_crack: 'Short-term weakness / drawdown worsening (price crack)',
      deterioration_followthrough: 'Macro follow-through (rates driving price)',
      composite_followthrough: 'Macro follow-through (rates driving price)'
    };
    const percentileContext = (value) => {
      if (value == null) return 'N/A';
      if (value <= 20) return 'low';
      if (value <= 79) return 'typical';
      if (value <= 94) return 'high';
      return 'extreme';
    };
    const percentileWord = (value) => {
      const context = percentileContext(value);
      if (context === 'N/A') return 'N/A';
      return `${context[0].toUpperCase()}${context.slice(1)}`;
    };
    const dedupeNote = (note) => {
      if (!note) return note;
      return note.replace(/(\bused available history\b)(\s+\1)+/gi, '$1');
    };
    const escapeHtml = (value) => String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
    const formatOrdinal = (value) => {
      const rounded = Math.round(value);
      const mod10 = rounded % 10;
      const mod100 = rounded % 100;
      if (mod10 === 1 && mod100 !== 11) return `${rounded}st`;
      if (mod10 === 2 && mod100 !== 12) return `${rounded}nd`;
      if (mod10 === 3 && mod100 !== 13) return `${rounded}rd`;
      return `${rounded}th`;
    };
    const percentileText = (value, explain) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      const cleaned = dedupeNote(explain);
      return `${percentileWord(value)} (${formatOrdinal(value)})${contextTag(cleaned ? `Note: ${cleaned}` : '')}`;
    };
    const valueOrNA = (value, formatter, explain) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      return `${formatter(value)}${contextTag(explain)}`;
    };
    const signedValue = (value, formatter) => {
      if (value == null) return 'N/A';
      const sign = value > 0 ? '+' : '';
      return `${sign}${formatter(value)}`;
    };
    const formatDistance = (value, unit) => {
      if (value == null) return 'â€”';
      if (unit === 'percent') return signedValue(value, (val) => `${(val * 100).toFixed(2)}%`);
      if (unit === 'bp') return signedValue(value, (val) => `${val.toFixed(0)} bp`);
      if (unit === 'pctile') return signedValue(value, (val) => `${Math.round(val)} pctile`);
      return signedValue(value, (val) => `${val}`);
    };
    const clamp01 = (value) => Math.max(0, Math.min(1, value));
    const transitionScore = (row) => {
      if (!row) return 0;
      if (row.fired === true) return 1;
      if (typeof row.distance !== 'number' || !Number.isFinite(row.distance)) return 0;
      const ramps = {
        percent: 0.05,
        bp: 25,
        pctile: 20,
      };
      const ramp = ramps[row.unit] ?? 1;
      return clamp01(1 - (Math.abs(row.distance) / ramp));
    };
    const renderTransitionThermometer = (row) => {
      const score = transitionScore(row);
      const pct = (score * 100).toFixed(1);
      const tooltip = row?.fired
        ? 'Trigger met'
        : `Proximity: ${pct}%`;
      return `
        <div class="mini-thermo" title="${tooltip}">
          <div class="mini-thermo-fill" style="width:${pct}%"></div>
          <div class="mini-thermo-marker" style="left:${pct}%"></div>
        </div>
      `;
    };
    const formatCurrent = (value, unit) => {
      if (value == null) return 'N/A';
      if (unit === 'percent') return formatPercent(value);
      if (unit === 'bp') return formatBp(value);
      if (unit === 'pctile') return `${formatOrdinal(value)} percentile`;
      return `${value}`;
    };
    const buildTransitionTable = (title, rows, note) => {
      if (!rows || rows.length === 0) {
        return `
          <details class="expandable-card" data-expand-group="mechanics">
            <summary>${title}</summary>
            <div class="expandable-body meta">No transition data available.</div>
          </details>
        `;
      }
      const noteHtml = note ? `<div class="meta">${note}</div>` : '';
      const bodyRows = rows.map((row) => `
        <tr>
          <td class="num">${row.fired == null ? 'N/A' : (row.fired ? 'Met' : 'Not met')}</td>
          <td class="num">
            <div class="distance-cell">
              <span>${formatDistance(row.distance, row.unit)}</span>
              ${renderTransitionThermometer(row)}
            </div>
          </td>
          <td>${row.trigger}${row.note ? contextTag(row.note) : ''}</td>
          <td class="num">${formatCurrent(row.current, row.unit)}</td>
          <td class="num">${row.threshold}</td>
        </tr>
      `).join('');
      return `
        <details class="expandable-card" data-expand-group="mechanics">
          <summary>${title}</summary>
          <div class="expandable-body">
            ${noteHtml}
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th class="num">Status</th>
                    <th class="num">Distance</th>
                    <th>Trigger</th>
                    <th class="num">Current</th>
                    <th class="num">Threshold</th>
                  </tr>
                </thead>
                <tbody>
                  ${bodyRows}
                </tbody>
              </table>
            </div>
          </div>
        </details>
      `;
    };
    const buildCard = (title, value, percentile, label, why) => `
      <div class="metric-card">
        <h3>${title}</h3>
        <div class="value">${value}</div>
        <div class="subtle">${label}${percentile != null ? ` â€¢ ${percentileWord(percentile)} (${formatOrdinal(percentile)})` : ''}</div>
        <div class="why">${why}</div>
      </div>
    `;
    const robustDataUrls = () => {
      const here = new URL(window.location.href);
      return [
        new URL('data.json', here).toString(),
        new URL('./data.json', here).toString(),
        new URL('../data.json', here).toString(),
      ];
    };

    const loadData = async () => {
      let lastError = null;
      for (const candidate of robustDataUrls()) {
        try {
          const response = await fetch(candidate, { cache: 'no-store' });
          if (!response.ok) {
            lastError = new Error(`HTTP ${response.status} for ${candidate}`);
            continue;
          }
          return await response.json();
        } catch (error) {
          lastError = error;
        }
      }
      throw lastError || new Error('Failed to load data.json');
    };

    loadData()
      .then((data) => {
        const regime = data.regime || {};
        const state = regime.state || data.flag || 'UNKNOWN';
        statusEl.textContent = state;
        statusEl.classList.remove('green', 'blue', 'orange', 'red');
        statusEl.classList.add(state.toLowerCase());
        statusSummaryEl.textContent = badgeDescriptions[state] || 'Status summary unavailable.';
        const macroFollowThrough = regime.flags?.macro_followthrough;
        macroFollowThroughEl.textContent = macroFollowThrough
          ? 'Macro shock is sticking (rates are driving price).'
          : 'Macro shock not confirmed (moves look more liquidation/positioning).';

        if (data.updated_at) {
          const etFormatted = formatTimestamp(data.updated_at);
          timestampsEl.textContent = `Updated ${etFormatted}`;
        }

        const reasons = regime.reasons || data.flag_triggers || [];
        reasonLeadEl.innerHTML = `<strong>Why ${state} today</strong>`;
        reasonsEl.innerHTML = reasons.length
          ? reasons.map((item) => {
            const label = escapeHtml(REASON_LABELS[item] || item);
            const reasonCode = escapeHtml(item);
            return `
              <li>
                <span class="reason-item">
                  <span>${label}</span>
                  <span class="reason-help" tabindex="0" aria-label="Show trigger code for ${label}">â“˜
                    <span class="reason-help-tooltip">Trigger code: <code>${reasonCode}</code></span>
                  </span>
                </span>
              </li>
            `;
          }).join('')
          : '<li>No active triggers.</li>';

        const metrics = data.metrics || {};
        const horizons = metrics.horizons || {};
        const horizonOrder = ['3M', '6M', '1Y', '3Y', '5Y'];
        horizonRows.innerHTML = horizonOrder.map((label) => {
          const horizon = horizons[label] || {};
          const available = horizon.available !== false && horizon.ret != null;
          const returnCell = available
            ? formatPercent(horizon.ret)
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const returnPctCell = available
            ? percentileText(
              horizon.ret_pctile_5y,
              horizon.ret_pctile_5y_explain
            )
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const drawdownCell = available
            ? formatPercent(horizon.max_drawdown)
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          const drawdownPctCell = available
            ? percentileText(
              horizon.max_drawdown_pctile_5y,
              horizon.max_drawdown_pctile_5y_explain
            )
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          const contextValue = percentileContext(horizon.ret_pctile_5y ?? horizon.max_drawdown_pctile_5y);
          return `
            <tr>
              <td>${label}</td>
              <td class="num">${returnCell}</td>
              <td class="num">${returnPctCell}</td>
              <td class="num">${drawdownCell}</td>
              <td class="num">${drawdownPctCell}</td>
              <td>${contextValue}</td>
            </tr>
          `;
        }).join('');

        const percentileNotes = data.notes?.percentile_notes || {};
        const notesEntries = Object.entries(percentileNotes);
        const notesText = notesEntries.length
          ? notesEntries.map(([key, value]) => `${key}: ${dedupeNote(value)}`).join(' | ')
          : 'none';
        const needsDetails = notesText.length > 140 || notesEntries.length > 2;
        percentileNotesEl.innerHTML = needsDetails
          ? `<details><summary>Percentile notes</summary>${notesText}</details>`
          : `<strong>Percentile notes:</strong> ${notesText}`;

        extensionRows.innerHTML = `
          <tr>
            <td>GLD % above 200DMA</td>
            <td class="num">${valueOrNA(metrics.pct_above_200dma, formatPercent)}</td>
            <td class="num">${percentileText(
              metrics.pct_above_200dma_pctile_5y,
              metrics.pct_above_200dma_pctile_5y_explain
            )}</td>
          </tr>
        `;

        const flows = metrics.flows || {};
        flowRows.innerHTML = `
          <tr>
            <td>Holdings today (tonnes)</td>
            <td class="num">${valueOrNA(flows.holdings_today_tonnes, formatTonnes)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Holdings change (5D)</td>
            <td class="num">${valueOrNA(flows.holdings_change_5d_pct, formatPercent)}</td>
            <td class="num">${percentileText(
              flows.holdings_change_5d_pct_pctile_5y,
              flows.holdings_change_5d_pct_pctile_5y_explain
            )}</td>
          </tr>
          <tr>
            <td>Holdings change (21D)</td>
            <td class="num">${valueOrNA(flows.holdings_change_21d_pct, formatPercent)}</td>
            <td class="num">${percentileText(
              flows.holdings_change_21d_pct_pctile_5y,
              flows.holdings_change_21d_pct_pctile_5y_explain
            )}</td>
          </tr>
        `;

        const macro = metrics.macro || {};
        const cut = macro.cut_style_classifier || {};
        const cutInputs = cut.inputs || {};
        const cutLabel = CUT_LABELS[cut.label] || cut.label || 'Unknown';
        const cutExplain = cutWhyText(cut.label || 'UNKNOWN');
        const cutDetails = (cut.explain && cut.explain.length)
          ? `<details><summary>Classifier details</summary>${cut.explain.map((item) => `<div class="context">${item}</div>`).join('')}</details>`
          : '';
        macroRows.innerHTML = `
          <tr>
            <td>Real yield today (DFII10)</td>
            <td class="num">${valueOrNA(macro.real_yield_today, (value) => `${value.toFixed(2)}%`)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Real yield change (1M)</td>
            <td class="num">${valueOrNA(macro.real_yield_change_1m_bp, formatBp)}</td>
            <td class="num">${percentileText(
              macro.real_yield_change_1m_bp_pctile_5y,
              macro.real_yield_change_1m_bp_pctile_5y_explain
            )}</td>
          </tr>
          <tr>
            <td>Real yield change (3M)</td>
            <td class="num">${valueOrNA(macro.real_yield_change_3m_bp, formatBp)}</td>
            <td class="num">${percentileText(
              macro.real_yield_change_3m_bp_pctile_5y,
              macro.real_yield_change_3m_bp_pctile_5y_explain
            )}</td>
          </tr>
          <tr>
            <td>20D corr (GLD ret vs real-yield Î”)</td>
            <td class="num">${valueOrNA(macro.corr_gld_ret_vs_real_yield_chg_20d, formatCorr)}</td>
            <td class="num">${percentileText(
              macro.corr_gld_ret_vs_real_yield_chg_20d_pctile_5y,
              macro.corr_gld_ret_vs_real_yield_chg_20d_pctile_5y_explain
            )}</td>
          </tr>

          <tr>
            <td colspan="3"><div class="divider"></div></td>
          </tr>
          <tr>
            <td>Cut style classifier</td>
            <td class="num">${cutLabel}${contextTag(cutExplain)}${cutDetails}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Nominal 2Y change (1M)</td>
            <td class="num">${valueOrNA(cutInputs.nominal_2y_change_1m_bp, formatBp)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Nominal 10Y change (1M)</td>
            <td class="num">${valueOrNA(cutInputs.nominal_10y_change_1m_bp, formatBp)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Breakeven 10Y change (1M)</td>
            <td class="num">${valueOrNA(cutInputs.breakeven_10y_change_1m_bp, formatBp)}</td>
            <td class="num">N/A</td>
          </tr>
          <tr>
            <td>Disinflation ratio (|Î”BE|/|Î”Nom10|)</td>
            <td class="num">${cutInputs.disinflation_ratio == null ? 'N/A' : formatNumber(cutInputs.disinflation_ratio, 2)}</td>
            <td class="num">N/A</td>
          </tr>
        `;
        const glanceCards = [
          buildCard(
            'Extension',
            valueOrNA(metrics.pct_above_200dma, formatPercent),
            metrics.pct_above_200dma_pctile_5y,
            'vs 200DMA',
            'How stretched price is vs trend'
          ),
          buildCard(
            '3M Return',
            valueOrNA(horizons['3M']?.ret, formatPercent),
            horizons['3M']?.ret_pctile_5y,
            'total return',
            'Recent momentum'
          ),
          buildCard(
            'Flows (21D)',
            valueOrNA(flows.holdings_change_21d_pct, formatPercent),
            flows.holdings_change_21d_pct_pctile_5y,
            '21D change',
            'ETF demand proxy'
          ),
          buildCard(
            'Real yields (1M)',
            valueOrNA(macro.real_yield_change_1m_bp, formatBp),
            macro.real_yield_change_1m_bp_pctile_5y,
            '1M change',
            'Macro pressure proxy'
          ),
          buildCard(
            'Macro link',
            valueOrNA(macro.corr_gld_ret_vs_real_yield_chg_20d, formatCorr),
            macro.corr_gld_ret_vs_real_yield_chg_20d_pctile_5y,
            '20D corr',
            'Is selling macro-driven? (more negative = more rate-linked)'
          ),
          (() => {
            const label = cut.label || 'UNKNOWN';
            const pretty = CUT_LABELS[label] || label;
            const ratio = cutInputs.disinflation_ratio;
            const ratioText = ratio == null ? 'N/A' : `${ratio.toFixed(2)}Ã—`;
            return buildCard(
              'Cut style',
              pretty,
              null,
              ratio == null ? 'classifier' : `BE/Nom ${ratioText}`,
              cutWhyText(label)
            );
          })()
        ];
        glanceCardsEl.innerHTML = glanceCards.join('');

        const transitions = regime.transitions || {};
        const deescalateRows = transitions.deescalate_to_blue || [];
        const redPrimaryRows = transitions.escalate_to_red_primary || [];
        const redCompositeRows = transitions.escalate_to_red_composite || [];
        const normalizeRows = transitions.normalize_to_green || [];

        const buildLocalRow = ({ trigger, thresholdLabel, current, thresholdValue, fired, unit, note }) => {
          let distance = null;
          if (current != null && thresholdValue != null) {
            distance = fired ? 0 : thresholdValue - current;
          }
          return {
            trigger,
            threshold: thresholdLabel,
            current,
            fired,
            distance,
            unit,
            note,
          };
        };

        const primaryRetPctile = horizons['3M']?.ret_pctile_5y;
        const drawdownPctile = horizons['3M']?.max_drawdown_pctile_5y;
        const extensionSignalRows = [
          buildLocalRow({
            trigger: 'Extension: 3M return percentile',
            thresholdLabel: 'â‰¥ 90th percentile',
            current: primaryRetPctile,
            thresholdValue: 90,
            fired: primaryRetPctile != null && primaryRetPctile >= 90,
            unit: 'pctile',
          }),
          buildLocalRow({
            trigger: 'Extension: % above 200DMA percentile',
            thresholdLabel: 'â‰¥ 90th percentile',
            current: metrics.pct_above_200dma_pctile_5y,
            thresholdValue: 90,
            fired: metrics.pct_above_200dma_pctile_5y != null && metrics.pct_above_200dma_pctile_5y >= 90,
            unit: 'pctile',
          }),
          buildLocalRow({
            trigger: 'Extension: 3M drawdown percentile',
            thresholdLabel: 'â‰¥ 70th percentile',
            current: drawdownPctile,
            thresholdValue: 70,
            fired: drawdownPctile != null && drawdownPctile >= 70,
            unit: 'pctile',
          }),
        ];

        const deteriorationTitle = state === 'GREEN'
          ? 'Hold position: deterioration signals (required for ORANGE once BLUE is active)'
          : 'Move down: de-escalate to BLUE (no deterioration triggers)';
        const deteriorationNote = state === 'GREEN'
          ? 'ORANGE requires BLUE plus at least one deterioration signal. If extension signals are not met, these do not change the color.'
          : 'All deterioration signals must clear for the regime to return to BLUE.';

        const extensionTitle = state === 'GREEN'
          ? 'Move up: escalate to BLUE (extension signals)'
          : 'Hold position: extension signals (still required for BLUE)';
        const extensionNote = 'BLUE requires at least 2 of the 3 extension signals.';

        escalationEl.innerHTML = `
          ${buildTransitionTable(
            extensionTitle,
            extensionSignalRows,
            extensionNote
          )}
          ${buildTransitionTable(
            deteriorationTitle,
            deescalateRows,
            deteriorationNote
          )}
          ${buildTransitionTable(
            'Move up: escalate to RED (primary triggers)',
            redPrimaryRows,
            'Any single primary trigger can move the regime to RED.'
          )}
          ${buildTransitionTable(
            'Move up: escalate to RED (composite: 2 of 5)',
            redCompositeRows,
            'Two or more composite signals would also trigger RED.'
          )}
          ${buildTransitionTable(
            'Move down: normalize to GREEN',
            normalizeRows,
            'Normalization requires percentile conditions to reset across price, flows, and macro.'
          )}
        `;

        const shortTermContext = percentileContext(horizons['3M']?.ret_pctile_5y);
        const longTermContext = percentileContext(horizons['1Y']?.ret_pctile_5y);
        horizonSummaryEl.textContent = `Context only: short-term ${shortTermContext}; long-term ${longTermContext}.`;

        const repo = data.repository || 'https://github.com/';
        repoLink.href = repo;

        if (data.latest_issue_url) {
          issueLink.innerHTML = ` Latest issue: <a href="${data.latest_issue_url}">${data.latest_issue_url}</a>`;
        }
      })
      .catch((error) => {
        statusEl.textContent = 'DATA ERROR';
        statusEl.classList.add('red');
        horizonRows.innerHTML = `<tr><td colspan="6">Failed to load data.json: ${error}</td></tr>`;
      });
  </script>
</body>
</html>
