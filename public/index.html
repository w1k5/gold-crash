<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gold Risk Monitor</title>
  <style>
    :root {
      color-scheme: light dark;
      --green: #2d6a4f;
      --blue: #2563eb;
      --orange: #f97316;
      --red: #b91c1c;
      --gray: #334155;
      --bg: #f8fafc;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg);
      color: #0f172a;
    }
    main {
      max-width: 1000px;
      margin: 0 auto;
      padding: 32px 20px 64px;
    }
    header {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: white;
      background: var(--gray);
      width: fit-content;
    }
    .badge.green { background: var(--green); }
    .badge.blue { background: var(--blue); }
    .badge.orange { background: var(--orange); }
    .badge.red { background: var(--red); }
    .meta {
      font-size: 14px;
      color: #475569;
    }
    .section {
      margin-top: 28px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }
    th, td {
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
      text-align: left;
      font-size: 15px;
      vertical-align: top;
    }
    th {
      background: #e2e8f0;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.08em;
    }
    tbody tr:last-child td {
      border-bottom: none;
    }
    .context {
      display: block;
      margin-top: 4px;
      font-size: 12px;
      color: #64748b;
    }
    .note {
      margin-top: 12px;
      padding: 12px 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      font-size: 14px;
      color: #334155;
    }
    .metric-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }
    .metric-indicator {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      display: inline-block;
      background: #94a3b8;
    }
    .metric-indicator.green { background: var(--green); }
    .metric-indicator.orange { background: var(--orange); }
    .metric-indicator.red { background: var(--red); }
    footer {
      margin-top: 32px;
      font-size: 13px;
      color: #64748b;
    }
    a { color: inherit; }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Gold Risk Monitor</h1>
      <div class="meta"><a href="/dislocation/">Dislocation detector â†’</a></div>
      <div id="status" class="badge">Loading...</div>
      <div class="meta" id="timestamps">Waiting for data...</div>
      <div class="meta">Status describes market regime only; it does not imply actions.</div>
    </header>

    <section class="section">
      <h2>Regime drivers</h2>
      <ul id="reasons" class="note">
        <li>Loading regime drivers...</li>
      </ul>
    </section>

    <section class="section">
      <h2>Horizon Snapshot</h2>
      <table>
        <thead>
          <tr>
            <th>Horizon</th>
            <th>Return</th>
            <th>Return Percentile</th>
            <th>Max Drawdown</th>
            <th>Drawdown Percentile</th>
          </tr>
        </thead>
        <tbody id="horizonRows">
          <tr><td colspan="5">Loading horizon metrics...</td></tr>
        </tbody>
      </table>
      <div class="note" id="percentileNotes"></div>
    </section>

    <section class="section">
      <h2>Extension</h2>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Percentile</th>
          </tr>
        </thead>
        <tbody id="extensionRows">
          <tr><td colspan="3">Loading extension data...</td></tr>
        </tbody>
      </table>
    </section>

    <section class="section">
      <h2>Flow (short-term)</h2>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Percentile</th>
          </tr>
        </thead>
        <tbody id="flowRows">
          <tr><td colspan="3">Loading flow data...</td></tr>
        </tbody>
      </table>
    </section>

    <section class="section">
      <h2>Macro (short-term)</h2>
      <table>
        <thead>
          <tr>
            <th>Metric</th>
            <th>Value</th>
            <th>Percentile</th>
          </tr>
        </thead>
        <tbody id="macroRows">
          <tr><td colspan="3">Loading macro data...</td></tr>
        </tbody>
      </table>
    </section>

    <footer>
      <p>
        Data is refreshed daily by GitHub Actions. View the repository on
        <a id="repoLink" href="https://github.com/">GitHub</a>.
        <span id="issueLink"></span>
      </p>
    </footer>
  </main>

  <script>
    const formatPercent = (value) => `${(value * 100).toFixed(2)}%`;
    const formatBp = (value) => `${value.toFixed(0)} bp`;
    const formatTonnes = (value) => `${value.toFixed(1)} t`;
    const formatTimestamp = (isoString) => {
      const date = new Date(isoString);
      const month = date.toLocaleString('en-US', { month: 'short' });
      const day = date.getDate();
      const year = date.getFullYear();
      const time = date.toLocaleString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
      return `${month} ${day}, ${year} ${time}`;
    };

    const statusEl = document.getElementById('status');
    const timestampsEl = document.getElementById('timestamps');
    const reasonsEl = document.getElementById('reasons');
    const horizonRows = document.getElementById('horizonRows');
    const percentileNotesEl = document.getElementById('percentileNotes');
    const extensionRows = document.getElementById('extensionRows');
    const flowRows = document.getElementById('flowRows');
    const macroRows = document.getElementById('macroRows');
    const repoLink = document.getElementById('repoLink');
    const issueLink = document.getElementById('issueLink');

    const contextTag = (text) => (text ? `<span class="context">${text}</span>` : '');
    const formatOrdinal = (value) => {
      const rounded = Math.round(value);
      const mod10 = rounded % 10;
      const mod100 = rounded % 100;
      if (mod10 === 1 && mod100 !== 11) return `${rounded}st`;
      if (mod10 === 2 && mod100 !== 12) return `${rounded}nd`;
      if (mod10 === 3 && mod100 !== 13) return `${rounded}rd`;
      return `${rounded}th`;
    };
    const percentileLabel = (basis, count) => {
      if (!basis || basis === 'none') return 'N/A';
      const label = basis === 'available' ? 'available history' : '5y window';
      const suffix = typeof count === 'number' ? ` (n=${count})` : '';
      return `${label}${suffix}`;
    };
    const percentileText = (value, explain, basis, count) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      const basisLabel = percentileLabel(basis, count);
      return `${formatOrdinal(value)} percentile${contextTag(explain ? `Note: ${explain}` : basisLabel)}`;
    };
    const valueOrNA = (value, formatter, explain) => {
      if (value == null) {
        return `N/A${contextTag(explain || 'insufficient history')}`;
      }
      return `${formatter(value)}${contextTag(explain)}`;
    };

    fetch('data.json', { cache: 'no-store' })
      .then((response) => response.json())
      .then((data) => {
        const regime = data.regime || {};
        const state = regime.state || data.flag || 'UNKNOWN';
        statusEl.textContent = state;
        statusEl.classList.add(state.toLowerCase());

        if (data.updated_at) {
          const etFormatted = formatTimestamp(data.updated_at);
          timestampsEl.textContent = `Updated ${etFormatted}`;
        }

        const reasons = regime.reasons || data.flag_triggers || [];
        reasonsEl.innerHTML = reasons.length
          ? reasons.map((item) => `<li>${item}</li>`).join('')
          : '<li>No active triggers.</li>';

        const metrics = data.metrics || {};
        const horizons = metrics.horizons || {};
        const horizonOrder = ['3M', '6M', '1Y', '3Y', '5Y'];
        horizonRows.innerHTML = horizonOrder.map((label) => {
          const horizon = horizons[label] || {};
          const available = horizon.available !== false && horizon.ret != null;
          const returnCell = available
            ? formatPercent(horizon.ret)
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const returnPctCell = available
            ? percentileText(
              horizon.ret_pctile_5y,
              horizon.ret_pctile_5y_explain,
              horizon.ret_pctile_basis,
              horizon.ret_pctile_n
            )
            : `N/A${contextTag(horizon.ret_pctile_5y_explain || 'insufficient history')}`;
          const drawdownCell = available
            ? formatPercent(horizon.max_drawdown)
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          const drawdownPctCell = available
            ? percentileText(
              horizon.max_drawdown_pctile_5y,
              horizon.max_drawdown_pctile_5y_explain,
              horizon.max_drawdown_pctile_basis,
              horizon.max_drawdown_pctile_n
            )
            : `N/A${contextTag(horizon.max_drawdown_pctile_5y_explain || 'insufficient history')}`;
          const labelNote = (data.notes && data.notes.percentile_notes && data.notes.percentile_notes[label])
            ? contextTag(data.notes.percentile_notes[label])
            : '';
          return `
            <tr>
              <td>${label}${labelNote}</td>
              <td>${returnCell}</td>
              <td>${returnPctCell}</td>
              <td>${drawdownCell}</td>
              <td>${drawdownPctCell}</td>
            </tr>
          `;
        }).join('');

        const percentileNotes = data.notes?.percentile_notes || {};
        const notesList = Object.keys(percentileNotes).length
          ? `<strong>Percentile notes:</strong> ${Object.entries(percentileNotes)
              .map(([key, value]) => `${key}: ${value}`)
              .join(' | ')}`
          : 'Percentile notes: none.';
        percentileNotesEl.innerHTML = notesList;

        extensionRows.innerHTML = `
          <tr>
            <td>GLD % above 200DMA</td>
            <td>${valueOrNA(metrics.pct_above_200dma, formatPercent)}</td>
            <td>${percentileText(
              metrics.pct_above_200dma_pctile_5y,
              metrics.pct_above_200dma_pctile_5y_explain,
              metrics.pct_above_200dma_pctile_basis,
              metrics.pct_above_200dma_pctile_n
            )}</td>
          </tr>
        `;

        const flows = metrics.flows || {};
        flowRows.innerHTML = `
          <tr>
            <td>Holdings today (tonnes)</td>
            <td>${valueOrNA(flows.holdings_today_tonnes, formatTonnes)}</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Holdings change (5D)</td>
            <td>${valueOrNA(flows.holdings_change_5d_pct, formatPercent)}</td>
            <td>${percentileText(
              flows.holdings_change_5d_pct_pctile_5y,
              flows.holdings_change_5d_pct_pctile_5y_explain,
              flows.holdings_change_5d_pctile_basis,
              flows.holdings_change_5d_pctile_n
            )}</td>
          </tr>
          <tr>
            <td>Holdings change (21D)</td>
            <td>${valueOrNA(flows.holdings_change_21d_pct, formatPercent)}</td>
            <td>${percentileText(
              flows.holdings_change_21d_pct_pctile_5y,
              flows.holdings_change_21d_pct_pctile_5y_explain,
              flows.holdings_change_21d_pctile_basis,
              flows.holdings_change_21d_pctile_n
            )}</td>
          </tr>
        `;

        const macro = metrics.macro || {};
        macroRows.innerHTML = `
          <tr>
            <td>Real yield today (DFII10)</td>
            <td>${valueOrNA(macro.real_yield_today, (value) => `${value.toFixed(2)}%`)}</td>
            <td>N/A</td>
          </tr>
          <tr>
            <td>Real yield change (1M)</td>
            <td>${valueOrNA(macro.real_yield_change_1m_bp, formatBp)}</td>
            <td>${percentileText(
              macro.real_yield_change_1m_bp_pctile_5y,
              macro.real_yield_change_1m_bp_pctile_5y_explain,
              macro.real_yield_change_1m_bp_pctile_basis,
              macro.real_yield_change_1m_bp_pctile_n
            )}</td>
          </tr>
          <tr>
            <td>Real yield change (3M)</td>
            <td>${valueOrNA(macro.real_yield_change_3m_bp, formatBp)}</td>
            <td>${percentileText(
              macro.real_yield_change_3m_bp_pctile_5y,
              macro.real_yield_change_3m_bp_pctile_5y_explain,
              macro.real_yield_change_3m_bp_pctile_basis,
              macro.real_yield_change_3m_bp_pctile_n
            )}</td>
          </tr>
        `;

        const repo = data.repository || 'https://github.com/';
        repoLink.href = repo;

        if (data.latest_issue_url) {
          issueLink.innerHTML = ` Latest issue: <a href="${data.latest_issue_url}">${data.latest_issue_url}</a>`;
        }
      })
      .catch((error) => {
        statusEl.textContent = 'DATA ERROR';
        statusEl.classList.add('red');
        horizonRows.innerHTML = `<tr><td colspan="5">Failed to load data.json: ${error}</td></tr>`;
      });
  </script>
</body>
</html>
