<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü´®</text></svg>">
  <title>Dislocation Detector</title>
  <style>
    :root{
      color-scheme: light dark;
      --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --shadow:0 10px 30px rgba(15,23,42,.08);
      --good:#16a34a; --warn:#f97316; --bad:#dc2626; --info:#2563eb;
      --pill-bg:rgba(2,6,23,.04);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2a44;
        --shadow:0 10px 30px rgba(0,0,0,.35);
        --pill-bg:rgba(148,163,184,.10);
      }
    }

    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;line-height:1.5;}
    main{max-width:1040px;margin:0 auto;padding:28px 18px 60px;}
    header{display:flex;justify-content:space-between;gap:14px;align-items:flex-start;flex-wrap:wrap;}
    h1{margin:0;font-size:28px;letter-spacing:-.02em;}
    .sub{margin:6px 0 0;color:var(--muted);font-size:14px;max-width:64ch;}
    a{color:var(--info);text-decoration:none;}
    a:hover{text-decoration:underline;}

    .grid{display:grid;gap:14px;margin-top:16px;}
    @media (min-width: 900px){
      .grid{grid-template-columns: 1.15fr .85fr;}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px 16px;
    }
    .card h2{margin:0 0 10px;font-size:16px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--border);
      background:var(--pill-bg);
      padding:8px 10px;border-radius:999px;font-size:13px;color:var(--muted);
    }
    .pill strong{color:var(--text);font-weight:600;}
    .statusBig{
      display:flex;flex-direction:column;gap:10px;
      padding:18px;border-radius:18px;border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(37,99,235,.08), transparent 60%);
    }
    .statusLine{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;font-size:13px;font-weight:600;
      border:1px solid transparent;
    }
    .b-good{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.25);color:var(--good);}
    .b-warn{background:rgba(249,115,22,.12);border-color:rgba(249,115,22,.25);color:var(--warn);}
    .b-bad{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.25);color:var(--bad);}
    .b-muted{background:rgba(148,163,184,.10);border-color:rgba(148,163,184,.20);color:var(--muted);}

    .bigNumber{font-size:38px;letter-spacing:-.03em;font-weight:700;margin:0;}
    .help{color:var(--muted);font-size:14px;margin:0;}

    .signalsGrid{
      display:grid;gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 650px){ .signalsGrid{grid-template-columns: 1fr 1fr;} }
    .sig{
      border:1px solid var(--border);border-radius:14px;padding:12px;
      display:flex;flex-direction:column;gap:8px;
    }
    .sigTop{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
    .sigName{font-weight:650;font-size:14px;margin:0;}
    .sigHint{margin:0;color:var(--muted);font-size:12px;}
    .thermoWrap{display:flex;flex-direction:column;gap:6px;}
    .thermoTrack{position:relative;height:8px;border-radius:999px;background:rgba(148,163,184,.25);overflow:visible;}
    .thermoFill{position:absolute;left:0;top:0;height:100%;border-radius:inherit;background:var(--info);transition:width .2s ease;}
    .thermoMarker{position:absolute;top:50%;width:10px;height:10px;border-radius:999px;background:var(--card);border:2px solid var(--info);transform:translate(-50%,-50%);transition:left .2s ease;box-sizing:border-box;}
    .thermoLabels{display:flex;justify-content:space-between;color:var(--muted);font-size:11px;}
    .thermoMuted{opacity:.5;}
    .thermoCaption{margin:0;color:var(--muted);font-size:11px;}
    details{border-top:1px dashed var(--border);padding-top:10px;}
    summary{cursor:pointer;color:var(--info);font-size:13px;user-select:none;}
    .kv{font-family:var(--mono);font-size:12px;color:var(--muted);white-space:pre-wrap;margin:8px 0 0;}
    .timeline{margin:0;padding-left:18px;color:var(--muted);font-size:13px;}
    .tiny{font-size:12px;color:var(--muted);margin:0;}
    .skeleton{opacity:.65}
  </style>
</head>

<body>
<main>
  <header>
    <div>
      <h1>Dislocation Detector</h1>
      <p class="sub">
        A low-churn ‚Äúmarket plumbing‚Äù monitor. It only flags a dislocation when multiple independent stress signals agree.
      </p>
      <p class="tiny"><a href="https://w1k5.github.io/gold-crash/">‚Üê Back to Gold Risk Monitor</a></p>
    </div>
    <div class="row">
      <span class="pill"><strong id="asof">As of</strong> <span id="asofVal" class="skeleton">Loading‚Ä¶</span></span>
      <span class="pill"><strong>Rule</strong> <span id="ruleVal" class="skeleton">Loading‚Ä¶</span></span>
    </div>
    <p class="tiny" id="dataDatesVal">Data dates: Loading‚Ä¶</p>
    <p class="tiny" id="countingVal">Signal counting: Loading‚Ä¶</p>
  </header>

  <div class="grid">
    <section class="card">
      <div class="statusBig">
        <div class="statusLine">
          <span id="statusBadge" class="badge b-muted">Loading‚Ä¶</span>
          <span class="pill"><strong>Signals today</strong> <span id="countVal" class="skeleton">‚Äî</span></span>
          <span class="pill"><strong>Yesterday</strong> <span id="yCountVal" class="skeleton">‚Äî</span></span>
        </div>
        <p class="bigNumber" id="statusHeadline">‚Äî</p>
        <p class="help" id="statusExplain" class="skeleton">
          Loading status‚Ä¶
        </p>
      </div>

      <div style="margin-top:14px;">
        <h2>What this means</h2>
        <p class="help" style="margin:0;">
          <strong>Normal</strong> = signals are quiet. <strong>Watch</strong> = at least one stress signal is elevated.
          <strong>Dislocation</strong> = a flow-driven event is likely (‚â•K signals, with optional persistence).
        </p>
      </div>
    </section>

    <section class="card">
      <h2>Recent transitions</h2>
      <ul id="transitions" class="timeline">
        <li class="skeleton">Loading‚Ä¶</li>
      </ul>
      <p class="tiny" id="persistenceNote" style="margin-top:12px;"></p>

      <details style="margin-top:14px;">
        <summary>Methodology (high level)</summary>
        <p class="help" style="margin-top:10px;">
          This page shows outcomes. The detector uses daily market data (e.g., SPY/HYG/GLD/VIX proxies) and checks for
          dislocation-style patterns: ‚Äúbig down + whipsaw‚Äù, ‚Äúvol spike‚Äù, ‚Äúcredit stress‚Äù, ‚Äúeverything sells together‚Äù, etc.
        </p>
        <p class="help">
          If you want implementation details, link out to the repo or keep the script on a separate /method page‚Äîdon‚Äôt put it on the dashboard.
        </p>
      </details>
    </section>
  </div>

  <section class="card" style="margin-top:14px;">
    <h2>Signals</h2>
    <p class="help" style="margin-top:-4px;">
      Each card is one independent check. The detector triggers only when enough cards flip to ‚ÄúTriggered‚Äù.
    </p>
    <div id="signals" class="signalsGrid">
      <div class="sig skeleton"><p class="sigName">Loading‚Ä¶</p><p class="sigHint">‚Äî</p></div>
      <div class="sig skeleton"><p class="sigName">Loading‚Ä¶</p><p class="sigHint">‚Äî</p></div>
    </div>
  </section>

</main>

<script>
  // ---- Helpers
  const fmtPct = (x) => (typeof x === 'number' && isFinite(x)) ? `${x.toFixed(2)}%` : '‚Äî';
  const fmtNum = (x) => (typeof x === 'number' && isFinite(x)) ? `${x.toFixed(2)}` : '‚Äî';
  const clamp01 = (x) => Math.max(0, Math.min(1, Number.isFinite(x) ? x : 0));
  const thermometerScore = (signal) => {
    const details = signal.details || {};
    const raw = Number(details.score_0_1);
    const base = Number.isFinite(raw) ? raw : (signal.triggered ? 1 : 0);
    return signal.triggered ? 1 : clamp01(base);
  };
  const marginText = (details) => {
    const margin = details?.margin;
    if (!Number.isFinite(margin)) return '';
    const unit = details?.margin_unit || '';
    if (margin >= 0) return `${Math.abs(margin).toFixed(2)}${unit} past trigger`;
    return `${Math.abs(margin).toFixed(2)}${unit} from trigger`;
  };

  const prettyName = (name) => {
    const map = {
      big_down_and_whipsaw: "Big down + whipsaw",
      liquidity_degraded_proxy: "Liquidity degraded (proxy)",
      volatility_spike: "Volatility spike",
      credit_stress_proxy: "Credit stress (proxy)",
      credit_spread_widening_fred: "HY credit spread widening",
      funding_stress_sofr_iorb: "Funding stress (SOFR-IORB)",
      repo_rate_volume_dislocation: "Repo rate/volume dislocation",
      rates_volatility_shock: "Rates volatility shock",
      everything_sells_together: "Everything sells together",
      forced_flow_proxy_combo: "Forced-flow combo (proxy)"
    };
    return map[name] || name.replaceAll('_',' ');
  };

  const tooltipText = (name) => {
    const map = {
      big_down_and_whipsaw: "Checks for sharp market losses combined with unusually violent intraday swings, a common sign of forced selling in thin liquidity.",
      liquidity_degraded_proxy: "Looks for outsized price moves relative to trading activity, suggesting markets may struggle to absorb trades smoothly.",
      volatility_spike: "Flags sudden jumps in implied volatility, which often accompany margin stress and rapid repositioning by leveraged players.",
      credit_stress_proxy: "Monitors whether high-yield bonds are underperforming equities, an early warning that risk tolerance and funding conditions are tightening.",
      credit_spread_widening_fred: "Detects widening junk-bond spreads, indicating investors are demanding more compensation for credit risk.",
      funding_stress_sofr_iorb: "Checks for unusual strains in overnight funding markets, where disruptions can signal balance-sheet or collateral pressure.",
      repo_rate_volume_dislocation: "Watches for abnormal repo rates or volumes that may reflect stress in the system‚Äôs primary financing channel.",
      rates_volatility_shock: "Tracks sudden increases in Treasury yield volatility, which can force deleveraging across markets due to rising margin requirements.",
      everything_sells_together: "Flags moments when typically diversifying assets fall together, a hallmark of liquidity-driven, indiscriminate selling.",
      forced_flow_proxy_combo: "Combines equity stress, credit weakness, and volatility pressure to confirm margin-driven or forced liquidation dynamics."
    };
    return map[name] || '';
  };

  const hint = (signal) => {
    const d = signal.details || {};
    switch(signal.name){
      case "big_down_and_whipsaw":
        return `SPY 1D ${fmtPct(d.spy_1d_return_pct)} ‚Ä¢ Range ${fmtPct(d.spy_intraday_range_pct)}`;
      case "liquidity_degraded_proxy":
        return `Dollar vol z ${fmtNum(d.spy_dollar_volume_z)} ‚Ä¢ Range z ${fmtNum(d.spy_range_z)}`;
      case "volatility_spike":
        if (d.note) return d.note;
        return `VIX ${fmtNum(d.vix_level)} ‚Ä¢ 1D ${fmtPct(d.vix_1d_change_pct)}`;
      case "credit_stress_proxy":
        return `HYG-SPY ${fmtPct(d.hyg_minus_spy_pct)} ‚Ä¢ HYG ${fmtPct(d.hyg_1d_return_pct)}`;
      case "credit_spread_widening_fred":
        return `HY OAS ${fmtNum(d.hy_oas_level)} ‚Ä¢ 5D ${fmtNum(d.hy_oas_5d_change)}`;
      case "funding_stress_sofr_iorb":
        return `SOFR-IORB ${fmtNum(d.sofr_iorb_spread_bp)}bp ‚Ä¢ 5D ${fmtNum(d.sofr_iorb_spread_5d_bp)}bp`;
      case "repo_rate_volume_dislocation":
        return `TGCR ${fmtNum(d.tgcr_rate)} ‚Ä¢ Vol 5D ${fmtPct(d.tgcr_volume_5d_change_pct)}`;
      case "rates_volatility_shock":
        return `10Y RV5 ${fmtNum(d.dgs10_rv5_bp)}bp ‚Ä¢ 5D 10Y ${fmtNum(d.dgs10_5d_change_bp)}bp`;
      case "everything_sells_together":
        return `SPY ${fmtPct(d.spy_1d_return_pct)} ‚Ä¢ GLD ${fmtPct(d.gld_1d_return_pct)}`;
      case "forced_flow_proxy_combo":
        if (d.note) return d.note;
        return `SPY ${fmtPct(d.spy_1d_return_pct)} ‚Ä¢ HYG-SPY ${fmtPct(d.hyg_minus_spy_pct)} ‚Ä¢ VIX ${fmtNum(d.vix_level)}`;
      default:
        return "‚Äî";
    }
  };

  const formatLocalDateTime = (value) => {
    if (!value) {
      return 'unknown';
    }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return value;
    }
    try {
      return new Intl.DateTimeFormat(undefined, {
        dateStyle: 'medium',
        timeStyle: 'short',
      }).format(date);
    } catch (_) {
      return date.toLocaleString();
    }
  };

  const formatLocalDate = (value) => {
    if (!value) {
      return 'unknown';
    }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return value;
    }
    try {
      return new Intl.DateTimeFormat(undefined, {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
      }).format(date);
    } catch (_) {
      return date.toLocaleDateString();
    }
  };

  const setStatus = (data) => {
    const badge = document.getElementById('statusBadge');
    const headline = document.getElementById('statusHeadline');
    const explain = document.getElementById('statusExplain');

    const count = data.signals_triggered_count ?? 0;
    const k = data.rule?.k_required ?? 3;

    if (data.status === "dislocation" || data.dislocation === true){
      badge.className = "badge b-bad";
      badge.textContent = "DISLOCATION";
      headline.textContent = "Flow-driven event likely";
      explain.textContent = `Triggered because ${count}/${k} signals are active (or persistence carried it). Expect correlations to rise and prices to gap more than usual.`;
      return;
    }
    if (data.watch === true || data.status === "stress_building" || count >= 1){
      badge.className = "badge b-warn";
      badge.textContent = "WATCH";
      headline.textContent = "Stress building";
      explain.textContent = `At least one stress signal is elevated (${count}/${k}). Not a dislocation yet‚Äîthis is an early-warning ‚Äúpay attention‚Äù state.`;
      return;
    }
    if (data.status === "data_stale"){
      badge.className = "badge b-muted";
      badge.textContent = "DATA STALE";
      headline.textContent = "Freshness guardrail triggered";
      explain.textContent = "At least one required series is stale beyond tolerance. Treat this run as informational until data refreshes.";
      return;
    }
    badge.className = "badge b-good";
    badge.textContent = "NORMAL";
    headline.textContent = "Conditions look normal";
    explain.textContent = `0/${k} dislocation signals. Liquidity/vol/credit relationships look typical today.`;
  };

  const renderSignals = (data) => {
    const root = document.getElementById('signals');
    root.innerHTML = '';

    const signals = Array.isArray(data.signals) ? data.signals : [];
    const excluded = Array.isArray(data.signal_counting?.excluded_from_threshold)
      ? data.signal_counting.excluded_from_threshold
      : [];
    const excludedSet = new Set(excluded.filter(Boolean));

    signals.forEach(s => {
      const card = document.createElement('div');
      card.className = 'sig';
      const tooltip = tooltipText(s.name);

      const top = document.createElement('div');
      top.className = 'sigTop';

      const left = document.createElement('div');
      const name = document.createElement('p');
      name.className = 'sigName';
      name.textContent = prettyName(s.name);
      left.appendChild(name);
      const small = document.createElement('p');
      small.className = 'sigHint';
      small.textContent = hint(s);
      left.appendChild(small);

      const b = document.createElement('span');
      const counted = s.details?.counted_toward_threshold ?? !excludedSet.has(s.name);
      if (!counted) {
        b.className = 'badge b-muted';
        b.textContent = 'Excluded from K';
      } else {
        b.className = `badge ${s.triggered ? 'b-bad' : 'b-muted'}`;
        b.textContent = s.triggered ? 'Triggered' : 'Not triggered';
      }

      top.appendChild(left);
      top.appendChild(b);

      const thermoWrap = document.createElement('div');
      thermoWrap.className = `thermoWrap ${counted ? '' : 'thermoMuted'}`;
      const score = thermometerScore(s);
      const pct = clamp01(score) * 100;

      const track = document.createElement('div');
      track.className = 'thermoTrack';

      const fill = document.createElement('div');
      fill.className = 'thermoFill';
      fill.style.width = `${pct}%`;

      const marker = document.createElement('div');
      marker.className = 'thermoMarker';
      marker.style.left = `${pct}%`;
      const markerTitle = marginText(s.details || {});
      marker.title = markerTitle || `${pct.toFixed(0)}% to trigger`;

      const labels = document.createElement('div');
      labels.className = 'thermoLabels';
      labels.innerHTML = '<span>Quiet</span><span>Trigger</span>';

      track.appendChild(fill);
      track.appendChild(marker);
      thermoWrap.appendChild(track);
      thermoWrap.appendChild(labels);

      if (!counted) {
        const caption = document.createElement('p');
        caption.className = 'thermoCaption';
        caption.textContent = 'Not counted toward threshold';
        thermoWrap.appendChild(caption);
      }

      const details = document.createElement('details');
      const summary = document.createElement('summary');
      summary.textContent = 'See underlying numbers';
      const kv = document.createElement('div');
      kv.className = 'kv';
      kv.textContent = JSON.stringify(s.details || {}, null, 2);

      const explanationDetails = document.createElement('details');
      const explanationSummary = document.createElement('summary');
      explanationSummary.textContent = 'Explanation';
      const explanation = document.createElement('p');
      explanation.className = 'help';
      explanation.style.margin = '8px 0 0';
      explanation.textContent = tooltip || 'No explanation available.';

      details.appendChild(summary);
      details.appendChild(kv);
      explanationDetails.appendChild(explanationSummary);
      explanationDetails.appendChild(explanation);

      card.appendChild(top);
      card.appendChild(thermoWrap);
      card.appendChild(details);
      card.appendChild(explanationDetails);
      root.appendChild(card);
    });

    if (signals.length === 0){
      const empty = document.createElement('p');
      empty.className = 'help';
      empty.textContent = 'No signal data available.';
      root.appendChild(empty);
    }
  };

  const renderTransitions = (data) => {
    const ul = document.getElementById('transitions');
    ul.innerHTML = '';
    const transitions = Array.isArray(data.transitions) ? data.transitions : [];
    if (transitions.length === 0){
      const li = document.createElement('li');
      li.textContent = 'No recent transitions logged.';
      ul.appendChild(li);
      return;
    }
    transitions.slice(-6).reverse().forEach(t => {
      const li = document.createElement('li');
      li.textContent = `${formatLocalDateTime(t.timestamp_utc)}: ${t.from} ‚Üí ${t.to}`;
      ul.appendChild(li);
    });
  };

  const robustJsonUrl = () => {
    // Works whether you‚Äôre at /gold-crash/dislocation/ or elsewhere.
    // Prefer the parent (site root) dislocation.json to avoid 404s in /dislocation/.
    const here = new URL(window.location.href);
    const tryParent = new URL('../dislocation.json', here).toString();
    const trySameFolder = new URL('dislocation.json', here).toString();
    return { tryParent, trySameFolder };
  };

  async function load(){
    const { trySameFolder, tryParent } = robustJsonUrl();

    let data = null;
    try {
      const r1 = await fetch(tryParent, { cache: "no-store" });
      if (r1.ok) data = await r1.json();
    } catch (e) {}

    if (!data){
      const r2 = await fetch(trySameFolder, { cache: "no-store" });
      if (!r2.ok) throw new Error('Failed to load dislocation.json');
      data = await r2.json();
    }

    document.getElementById('asofVal').textContent = formatLocalDateTime(data.asof_utc);
    document.getElementById('ruleVal').textContent = `${data.rule?.k_required ?? 3} signals`;
    document.getElementById('countVal').textContent = `${data.signals_triggered_count ?? 0}`;
    document.getElementById('yCountVal').textContent = `${data.signals_triggered_count_yesterday ?? 0}`;
    const dataDates = data.data_dates || {};
    const sessionDate = formatLocalDate(dataDates.equity_session_date);
    const equitiesDate = formatLocalDate(dataDates.equities_close_utc);
    const vixDate = formatLocalDate(dataDates.vix_close_utc);
    const vixStale = dataDates.vix_stale_days;
    const staleReasons = Array.isArray(dataDates.stale_reasons) && dataDates.stale_reasons.length
      ? `; stale reasons: ${dataDates.stale_reasons.join(', ')}`
      : '';
    let staleNote = 'staleness unknown';
    if (typeof vixStale === 'number' && isFinite(vixStale)) {
      staleNote = vixStale === 0 ? 'same session' : `${vixStale} day${vixStale === 1 ? '' : 's'} stale`;
    }
    document.getElementById('dataDatesVal').textContent =
      `Data dates: equity session ${sessionDate}; equities close ${equitiesDate}; VIX close ${vixDate} (${staleNote})${staleReasons}.`;

    const excluded = Array.isArray(data.signal_counting?.excluded_from_threshold)
      ? data.signal_counting.excluded_from_threshold.filter(Boolean)
      : [];
    const countNote = data.signal_counting?.notes || '';
    document.getElementById('countingVal').textContent = excluded.length
      ? `Signal counting: excluded from threshold ‚Üí ${excluded.join(', ')}. ${countNote}`
      : 'Signal counting: all standard signals included in threshold counting.';

    const p = data.rule?.persistence;
    const pEl = document.getElementById('persistenceNote');
    if (p?.enabled){
      pEl.textContent = `Persistence: holds if today is ${p.today_minimum} and yesterday had ‚â•${p.yesterday_minimum}.`;
    } else {
      pEl.textContent = '';
    }

    setStatus(data);
    renderSignals(data);
    renderTransitions(data);
  }

  load().catch(() => {
    document.getElementById('statusBadge').className = "badge b-muted";
    document.getElementById('statusBadge').textContent = "ERROR";
    document.getElementById('statusHeadline').textContent = "Couldn‚Äôt load data";
    document.getElementById('statusExplain').textContent = "dislocation.json failed to load. Check path and GitHub Pages publishing.";
    document.getElementById('signals').innerHTML = '<p class="help">Signal details unavailable.</p>';
    document.getElementById('transitions').innerHTML = '<li>Transition details unavailable.</li>';
    document.getElementById('dataDatesVal').textContent = 'Data dates: unavailable.';
    document.getElementById('countingVal').textContent = 'Signal counting: unavailable.';
  });
</script>
</body>
</html>
